<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Configuring external databases</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.2"/><meta name="description" content="As an administrator, you can configure and use external PostgreSQL databases in Red Hat Developer Hub."/><link rel="next" href="#idm46354230132384" title="Preface"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm46354230592784"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Developer Hub</span> <span class="productnumber">1.4</span></div><div><h1 class="title">Configuring external databases</h1></div><div><h2 class="subtitle">Configuring Red Hat Developer Hub to use external PostgreSQL databases</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat Customer Content Services</span></div></div><div><a href="#idm46354213101360">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				As an administrator, you can configure and use external PostgreSQL databases in Red Hat Developer Hub.
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="preface"><a href="#idm46354230132384">Preface</a></span></li><li><span class="chapter"><a href="#proc-configuring-postgresql-instance-using-operator_configuring-external-postgresql-databases">1. Configuring an external PostgreSQL instance using the Operator</a></span></li><li><span class="chapter"><a href="#proc-configuring-postgresql-instance-using-helm_configuring-external-postgresql-databases">2. Configuring an external PostgreSQL instance using the Helm Chart</a></span></li><li><span class="chapter"><a href="#proc-migrating-databases-to-an-external-server_configuring-external-postgresql-databases">3. Migrating local databases to an external database server using the Operator</a></span></li></ul></div><section class="preface" id="idm46354230132384"><div class="titlepage"><div><div><h1 class="title">Preface</h1></div></div></div><p>
			As an administrator, you can configure and use external PostgreSQL databases in Red Hat Developer Hub. You can use a PostgreSQL certificate file to configure an external PostgreSQL instance using the Operator or Helm Chart.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				Developer Hub supports the configuration of external PostgreSQL databases. You can perform maintenance activities, such as backing up your data or configuring high availability (HA) for the external PostgreSQL databases.
			</p><p>
				By default, the Red Hat Developer Hub operator or Helm Chart creates a local PostgreSQL database. However, this configuration is not suitable for the production environments. For production deployments, disable the creation of local database and configure Developer Hub to connect to an external PostgreSQL instance instead.
			</p></div></div></section><section class="chapter" id="proc-configuring-postgresql-instance-using-operator_configuring-external-postgresql-databases"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Configuring an external PostgreSQL instance using the Operator</h1></div></div></div><p>
			You can configure an external PostgreSQL instance using the Red Hat Developer Hub Operator. By default, the Operator creates and manages a local instance of PostgreSQL in the same namespace where you have deployed the RHDH instance. However, you can change this default setting to configure an external PostgreSQL database server, for example, Amazon Web Services (AWS) Relational Database Service (RDS) or Azure database.
		</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
					You are using a supported version of PostgreSQL. For more information, see the <a class="link" href="https://access.redhat.com/support/policy/updates/developerhub">Product life cycle page</a>.
				</li><li class="listitem"><p class="simpara">
					You have the following details:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
							<code class="literal">db-host</code>: Denotes your PostgreSQL instance Domain Name System (DNS) or IP address
						</li><li class="listitem">
							<code class="literal">db-port</code>: Denotes your PostgreSQL instance port number, such as <code class="literal">5432</code>
						</li><li class="listitem">
							<code class="literal">username</code>: Denotes the user name to connect to your PostgreSQL instance
						</li><li class="listitem">
							<code class="literal">password</code>: Denotes the password to connect to your PostgreSQL instance
						</li></ul></div></li><li class="listitem">
					You have installed the Red Hat Developer Hub Operator.
				</li><li class="listitem">
					Optional: You have a CA certificate, Transport Layer Security (TLS) private key, and TLS certificate so that you can secure your database connection by using the TLS protocol. For more information, refer to your PostgreSQL vendor documentation.
				</li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				By default, Developer Hub uses a database for each plugin and automatically creates it if none is found. You might need the <code class="literal">Create Database</code> privilege in addition to <code class="literal">PSQL Database</code> privileges for configuring an external PostgreSQL instance.
			</p></div></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
					Optional: Create a certificate secret to configure your PostgreSQL instance with a TLS connection:
				</p><pre class="programlisting language-yaml">cat &lt;&lt;EOF | oc -n &lt;your-namespace&gt; create -f -
apiVersion: v1
kind: Secret
metadata:
 name: &lt;crt-secret&gt; <span id="CO1-1"/><span class="callout">1</span>
type: Opaque
stringData:
 postgres-ca.pem: |-
  -----BEGIN CERTIFICATE-----
  &lt;ca-certificate-key&gt; <span id="CO1-2"/><span class="callout">2</span>
 postgres-key.key: |-
  -----BEGIN CERTIFICATE-----
  &lt;tls-private-key&gt; <span id="CO1-3"/><span class="callout">3</span>
 postgres-crt.pem: |-
  -----BEGIN CERTIFICATE-----
  &lt;tls-certificate-key&gt; <span id="CO1-4"/><span class="callout">4</span>
  # ...
EOF</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO1-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Provide the name of the certificate secret.
						</div></dd><dt><a href="#CO1-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide the CA certificate key.
						</div></dd><dt><a href="#CO1-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Optional: Provide the TLS private key.
						</div></dd><dt><a href="#CO1-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							Optional: Provide the TLS certificate key.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Create a credential secret to connect with the PostgreSQL instance:
				</p><pre class="programlisting language-yaml">cat &lt;&lt;EOF | oc -n &lt;your-namespace&gt; create -f -
apiVersion: v1
kind: Secret
metadata:
 name: &lt;cred-secret&gt; <span id="CO2-1"/><span class="callout">1</span>
type: Opaque
stringData: <span id="CO2-2"/><span class="callout">2</span>
 POSTGRES_PASSWORD: &lt;password&gt;
 POSTGRES_PORT: "&lt;db-port&gt;"
 POSTGRES_USER: &lt;username&gt;
 POSTGRES_HOST: &lt;db-host&gt;
 PGSSLMODE: &lt;ssl-mode&gt; # for TLS connection <span id="CO2-3"/><span class="callout">3</span>
 NODE_EXTRA_CA_CERTS: &lt;abs-path-to-pem-file&gt; # for TLS connection, e.g. /opt/app-root/src/postgres-crt.pem <span id="CO2-4"/><span class="callout">4</span>
EOF</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO2-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Provide the name of the credential secret.
						</div></dd><dt><a href="#CO2-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide credential data to connect with your PostgreSQL instance.
						</div></dd><dt><a href="#CO2-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Optional: Provide the value based on the required <a class="link" href="https://www.postgresql.org/docs/15/libpq-connect.html#LIBPQ-CONNECT-SSLMODE">Secure Sockets Layer (SSL) mode</a>.
						</div></dd><dt><a href="#CO2-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							Optional: Provide the value only if you need a TLS connection for your PostgreSQL instance.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Create a <code class="literal">Backstage</code> custom resource (CR):
				</p><pre class="programlisting language-terminal">cat &lt;&lt;EOF | oc -n &lt;your-namespace&gt; create -f -
apiVersion: rhdh.redhat.com/v1alpha1
kind: Backstage
metadata:
  name: &lt;backstage-instance-name&gt;
spec:
  database:
    enableLocalDb: false <span id="CO3-1"/><span class="callout">1</span>
  application:
    extraFiles:
      mountPath: &lt;path&gt; # e g /opt/app-root/src
      secrets:
        - name: &lt;crt-secret&gt; <span id="CO3-2"/><span class="callout">2</span>
          key: postgres-crt.pem, postgres-ca.pem, postgres-key.key # key name as in &lt;crt-secret&gt; Secret
    extraEnvs:
      secrets:
        - name: &lt;cred-secret&gt; <span id="CO3-3"/><span class="callout">3</span>
        # ...</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO3-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Set the value of the <code class="literal">enableLocalDb</code> parameter to <code class="literal">false</code> to disable creating local PostgreSQL instances.
						</div></dd><dt><a href="#CO3-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide the name of the certificate secret if you have configured a TLS connection.
						</div></dd><dt><a href="#CO3-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Provide the name of the credential secret that you created.
						</div></dd></dl></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						The environment variables listed in the <code class="literal">Backstage</code> CR work with the Operator default configuration. If you have changed the Operator default configuration, you must reconfigure the <code class="literal">Backstage</code> CR accordingly.
					</p></div></div></li><li class="listitem">
					Apply the <code class="literal">Backstage</code> CR to the namespace where you have deployed the RHDH instance.
				</li></ol></div></section><section class="chapter" id="proc-configuring-postgresql-instance-using-helm_configuring-external-postgresql-databases"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Configuring an external PostgreSQL instance using the Helm Chart</h1></div></div></div><p>
			You can configure an external PostgreSQL instance by using the Helm Chart. By default, the Helm Chart creates and manages a local instance of PostgreSQL in the same namespace where you have deployed the RHDH instance. However, you can change this default setting to configure an external PostgreSQL database server, for example, Amazon Web Services (AWS) Relational Database Service (RDS) or Azure database.
		</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
					You are using a supported version of PostgreSQL. For more information, see the <a class="link" href="https://access.redhat.com/support/policy/updates/developerhub">Product life cycle page</a>.
				</li><li class="listitem"><p class="simpara">
					You have the following details:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
							<code class="literal">db-host</code>: Denotes your PostgreSQL instance Domain Name System (DNS) or IP address
						</li><li class="listitem">
							<code class="literal">db-port</code>: Denotes your PostgreSQL instance port number, such as <code class="literal">5432</code>
						</li><li class="listitem">
							<code class="literal">username</code>: Denotes the user name to connect to your PostgreSQL instance
						</li><li class="listitem">
							<code class="literal">password</code>: Denotes the password to connect to your PostgreSQL instance
						</li></ul></div></li><li class="listitem">
					You have installed the RHDH application by using the Helm Chart.
				</li><li class="listitem">
					Optional: You have a CA certificate, Transport Layer Security (TLS) private key, and TLS certificate so that you can secure your database connection by using the TLS protocol. For more information, refer to your PostgreSQL vendor documentation.
				</li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				By default, Developer Hub uses a database for each plugin and automatically creates it if none is found. You might need the <code class="literal">Create Database</code> privilege in addition to <code class="literal">PSQL Database</code> privileges for configuring an external PostgreSQL instance.
			</p></div></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
					Optional: Create a certificate secret to configure your PostgreSQL instance with a TLS connection:
				</p><pre class="programlisting language-terminal">cat &lt;&lt;EOF | oc -n &lt;your-namespace&gt; create -f -
apiVersion: v1
kind: Secret
metadata:
 name: &lt;crt-secret&gt; <span id="CO4-1"/><span class="callout">1</span>
type: Opaque
stringData:
 postgres-ca.pem: |-
  -----BEGIN CERTIFICATE-----
  &lt;ca-certificate-key&gt; <span id="CO4-2"/><span class="callout">2</span>
 postgres-key.key: |-
  -----BEGIN CERTIFICATE-----
  &lt;tls-private-key&gt; <span id="CO4-3"/><span class="callout">3</span>
 postgres-crt.pem: |-
  -----BEGIN CERTIFICATE-----
  &lt;tls-certificate-key&gt; <span id="CO4-4"/><span class="callout">4</span>
  # ...
EOF</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO4-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Provide the name of the certificate secret.
						</div></dd><dt><a href="#CO4-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide the CA certificate key.
						</div></dd><dt><a href="#CO4-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Optional: Provide the TLS private key.
						</div></dd><dt><a href="#CO4-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							Optional: Provide the TLS certificate key.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Create a credential secret to connect with the PostgreSQL instance:
				</p><pre class="programlisting language-terminal">cat &lt;&lt;EOF | oc -n &lt;your-namespace&gt; create -f -
apiVersion: v1
kind: Secret
metadata:
 name: &lt;cred-secret&gt; <span id="CO5-1"/><span class="callout">1</span>
type: Opaque
stringData: <span id="CO5-2"/><span class="callout">2</span>
 POSTGRES_PASSWORD: &lt;password&gt;
 POSTGRES_PORT: "&lt;db-port&gt;"
 POSTGRES_USER: &lt;username&gt;
 POSTGRES_HOST: &lt;db-host&gt;
 PGSSLMODE: &lt;ssl-mode&gt; # for TLS connection <span id="CO5-3"/><span class="callout">3</span>
 NODE_EXTRA_CA_CERTS: &lt;abs-path-to-pem-file&gt; # for TLS connection, e.g. /opt/app-root/src/postgres-crt.pem <span id="CO5-4"/><span class="callout">4</span>
EOF</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO5-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Provide the name of the credential secret.
						</div></dd><dt><a href="#CO5-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide credential data to connect with your PostgreSQL instance.
						</div></dd><dt><a href="#CO5-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Optional: Provide the value based on the required <a class="link" href="https://www.postgresql.org/docs/15/libpq-connect.html#LIBPQ-CONNECT-SSLMODE">Secure Sockets Layer (SSL) mode</a>.
						</div></dd><dt><a href="#CO5-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							Optional: Provide the value only if you need a TLS connection for your PostgreSQL instance.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Configure your PostgreSQL instance in the Helm configuration file named <code class="literal">values.yaml</code>:
				</p><pre class="programlisting language-yaml"># ...
upstream:
  postgresql:
    enabled: false  # disable PostgreSQL instance creation <span id="CO6-1"/><span class="callout">1</span>
    auth:
      existingSecret: &lt;cred-secret&gt; # inject credentials secret to Backstage <span id="CO6-2"/><span class="callout">2</span>
  backstage:
    appConfig:
      backend:
        database:
          connection:  # configure Backstage DB connection parameters
            host: ${POSTGRES_HOST}
            port: ${POSTGRES_PORT}
            user: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
            ssl:
              rejectUnauthorized: true,
              ca:
                $file: /opt/app-root/src/postgres-ca.pem
              key:
                $file: /opt/app-root/src/postgres-key.key
              cert:
                $file: /opt/app-root/src/postgres-crt.pem
  extraEnvVarsSecrets:
    - &lt;cred-secret&gt; # inject credentials secret to Backstage <span id="CO6-3"/><span class="callout">3</span>
  extraEnvVars:
    - name: BACKEND_SECRET
      valueFrom:
        secretKeyRef:
          key: backend-secret
          name: '{{ include "janus-idp.backend-secret-name" $ }}'
  extraVolumeMounts:
    - mountPath: /opt/app-root/src/dynamic-plugins-root
      name: dynamic-plugins-root
    - mountPath: /opt/app-root/src/postgres-crt.pem
      name: postgres-crt # inject TLS certificate to Backstage cont. <span id="CO6-4"/><span class="callout">4</span>
      subPath: postgres-crt.pem
    - mountPath: /opt/app-root/src/postgres-ca.pem
      name: postgres-ca # inject CA certificate to Backstage cont. <span id="CO6-5"/><span class="callout">5</span>
      subPath: postgres-ca.pem
    - mountPath: /opt/app-root/src/postgres-key.key
      name: postgres-key # inject TLS private key to Backstage cont. <span id="CO6-6"/><span class="callout">6</span>
      subPath: postgres-key.key
  extraVolumes:
    - ephemeral:
        volumeClaimTemplate:
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
      name: dynamic-plugins-root
    - configMap:
        defaultMode: 420
        name: dynamic-plugins
        optional: true
      name: dynamic-plugins
    - name: dynamic-plugins-npmrc
      secret:
        defaultMode: 420
        optional: true
        secretName: dynamic-plugins-npmrc
    - name: postgres-crt
      secret:
        secretName: &lt;crt-secret&gt; <span id="CO6-7"/><span class="callout">7</span>
        # ...</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO6-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							Set the value of the <code class="literal">upstream.postgresql.enabled</code> parameter to <code class="literal">false</code> to disable creating local PostgreSQL instances.
						</div></dd><dt><a href="#CO6-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							Provide the name of the credential secret.
						</div></dd><dt><a href="#CO6-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							Provide the name of the credential secret.
						</div></dd><dt><a href="#CO6-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							Optional: Provide the name of the TLS certificate only for a TLS connection.
						</div></dd><dt><a href="#CO6-5"><span class="callout">5</span></a> </dt><dd><div class="para">
							Optional: Provide the name of the CA certificate only for a TLS connection.
						</div></dd><dt><a href="#CO6-6"><span class="callout">6</span></a> </dt><dd><div class="para">
							Optional: Provide the name of the TLS private key only if your TLS connection requires a private key.
						</div></dd><dt><a href="#CO6-7"><span class="callout">7</span></a> </dt><dd><div class="para">
							Provide the name of the certificate secret if you have configured a TLS connection.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Apply the configuration changes in your Helm configuration file named <code class="literal">values.yaml</code>:
				</p><pre class="programlisting language-terminal">helm upgrade -n &lt;your-namespace&gt; &lt;your-deploy-name&gt; openshift-helm-charts/redhat-developer-hub -f values.yaml --version 1.4.0</pre></li></ol></div></section><section class="chapter" id="proc-migrating-databases-to-an-external-server_configuring-external-postgresql-databases"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Migrating local databases to an external database server using the Operator</h1></div></div></div><p>
			By default, Red Hat Developer Hub hosts the data for each plugin in a PostgreSQL database. When you fetch the list of databases, you might see multiple databases based on the number of plugins configured in Developer Hub. You can migrate the data from an RHDH instance hosted on a local PostgreSQL server to an external PostgreSQL service, such as AWS RDS, Azure database, or Crunchy database. To migrate the data from each RHDH instance, you can use PostgreSQL utilities, such as <a class="link" href="https://www.postgresql.org/docs/current/app-pgdump.html"><code class="literal">pg_dump</code></a> with <a class="link" href="https://www.postgresql.org/docs/current/app-psql.html"><code class="literal">psql</code></a> or <a class="link" href="https://www.pgadmin.org/"><code class="literal">pgAdmin</code></a>.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				The following procedure uses a database copy script to do a quick migration.
			</p></div></div><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
					You have installed the <a class="link" href="https://www.postgresql.org/docs/current/app-pgdump.html"><code class="literal">pg_dump</code></a> and <a class="link" href="https://www.postgresql.org/docs/current/app-psql.html"><code class="literal">psql</code></a> utilities on your local machine.
				</li><li class="listitem">
					For data export, you have the PGSQL user privileges to make a full dump of local databases.
				</li><li class="listitem">
					For data import, you have the PGSQL admin privileges to create an external database and populate it with database dumps.
				</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
					Configure port forwarding for the local PostgreSQL database pod by running the following command on a terminal:
				</p><pre class="programlisting language-terminal">oc port-forward -n &lt;your-namespace&gt; &lt;pgsql-pod-name&gt; &lt;forward-to-port&gt;:&lt;forward-from-port&gt;</pre><p class="simpara">
					Where:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The <code class="literal">&lt;pgsql-pod-name&gt;</code> variable denotes the name of a PostgreSQL pod with the format <code class="literal">backstage-psql-&lt;deployment-name&gt;-&lt;_index&gt;</code>.
						</li><li class="listitem">
							The <code class="literal">&lt;forward-to-port&gt;</code> variable denotes the port of your choice to forward PostgreSQL data to.
						</li><li class="listitem"><p class="simpara">
							The <code class="literal">&lt;forward-from-port&gt;</code> variable denotes the local PostgreSQL instance port, such as <code class="literal">5432</code>.
						</p><div class="formalpara"><p class="title"><strong>Example: Configuring port forwarding</strong></p><p>
								
<pre class="programlisting language-terminal">oc port-forward -n developer-hub backstage-psql-developer-hub-0 15432:5432</pre>
							</p></div></li></ul></div></li><li class="listitem"><p class="simpara">
					Make a copy of the following <code class="literal">db_copy.sh</code> script and edit the details based on your configuration:
				</p><pre class="programlisting language-bash">#!/bin/bash

to_host=&lt;db-service-host&gt; <span id="CO7-1"/><span class="callout">1</span>
to_port=5432 <span id="CO7-2"/><span class="callout">2</span>
to_user=postgres <span id="CO7-3"/><span class="callout">3</span>

from_host=127.0.0.1 <span id="CO7-4"/><span class="callout">4</span>
from_port=15432 <span id="CO7-5"/><span class="callout">5</span>
from_user=postgres <span id="CO7-6"/><span class="callout">6</span>

allDB=("backstage_plugin_app" "backstage_plugin_auth" "backstage_plugin_catalog" "backstage_plugin_permission" "backstage_plugin_scaffolder" "backstage_plugin_search") <span id="CO7-7"/><span class="callout">7</span>

for db in ${!allDB[@]};
do
  db=${allDB[$db]}
  echo Copying database: $db
  PGPASSWORD=$TO_PSW psql -h $to_host -p $to_port -U $to_user -c "create database $db;"
  pg_dump -h $from_host -p $from_port -U $from_user -d $db | PGPASSWORD=$TO_PSW psql -h $to_host -p $to_port -U $to_user -d $db
done</pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO7-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							The destination host name, for example, <code class="literal">&lt;db-instance-name&gt;.rds.amazonaws.com</code>.
						</div></dd><dt><a href="#CO7-2"><span class="callout">2</span></a> </dt><dd><div class="para">
							The destination port, such as <code class="literal">5432</code>.
						</div></dd><dt><a href="#CO7-3"><span class="callout">3</span></a> </dt><dd><div class="para">
							The destination server username, for example, <code class="literal">postgres</code>.
						</div></dd><dt><a href="#CO7-4"><span class="callout">4</span></a> </dt><dd><div class="para">
							The source host name, such as <code class="literal">127.0.0.1</code>.
						</div></dd><dt><a href="#CO7-5"><span class="callout">5</span></a> </dt><dd><div class="para">
							The source port number, such as the <code class="literal">&lt;forward-to-port&gt;</code> variable.
						</div></dd><dt><a href="#CO7-6"><span class="callout">6</span></a> </dt><dd><div class="para">
							The source server username, for example, <code class="literal">postgres</code>.
						</div></dd><dt><a href="#CO7-7"><span class="callout">7</span></a> </dt><dd><div class="para">
							The name of databases to import in double quotes separated by spaces, for example, <code class="literal">("backstage_plugin_app" "backstage_plugin_auth" "backstage_plugin_catalog" "backstage_plugin_permission" "backstage_plugin_scaffolder" "backstage_plugin_search")</code>.
						</div></dd></dl></div></li><li class="listitem"><p class="simpara">
					Create a destination database for copying the data:
				</p><pre class="programlisting language-terminal">/bin/bash TO_PSW=&lt;destination-db-password&gt; /path/to/db_copy.sh <span id="CO8-1"/><span class="callout">1</span></pre><div class="calloutlist"><dl class="calloutlist"><dt><a href="#CO8-1"><span class="callout">1</span></a> </dt><dd><div class="para">
							The <code class="literal">&lt;destination-db-password&gt;</code> variable denotes the password to connect to the destination database.
						</div></dd></dl></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						You can stop port forwarding when the copying of the data is complete. For more information about handling large databases and using the compression tools, see the <a class="link" href="https://www.postgresql.org/docs/current/backup-dump.html#BACKUP-DUMP-LARGE">Handling Large Databases</a> section on the PostgreSQL website.
					</p></div></div></li><li class="listitem">
					Reconfigure your <code class="literal">Backstage</code> custom resource (CR). For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_developer_hub/1.4/html-single/administration_guide_for_red_hat_developer_hub/index#proc-configuring-postgresql-instance-using-operator_admin-rhdh">Configuring an external PostgreSQL instance using the Operator</a>.
				</li><li class="listitem"><p class="simpara">
					Check that the following code is present at the end of your <code class="literal">Backstage</code> CR after reconfiguration:
				</p><pre class="programlisting language-yaml"># ...
spec:
  database:
    enableLocalDb: false
  application:
  # ...
    extraFiles:
      secrets:
        - name: &lt;crt-secret&gt;
          key: postgres-crt.pem # key name as in &lt;crt-secret&gt; Secret
    extraEnvs:
      secrets:
        - name: &lt;cred-secret&gt;
# ...</pre><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						Reconfiguring the <code class="literal">Backstage</code> CR deletes the corresponding <code class="literal">StatefulSet</code> and <code class="literal">Pod</code> objects, but does not delete the <code class="literal">PersistenceVolumeClaim</code> object. Use the following command to delete the local <code class="literal">PersistenceVolumeClaim</code> object:
					</p><pre class="programlisting language-terminal">oc -n developer-hub delete pvc &lt;local-psql-pvc-name&gt;</pre><p>
						where, the <code class="literal">&lt;local-psql-pvc-name&gt;</code> variable is in the <code class="literal">data-&lt;psql-pod-name&gt;</code> format.
					</p></div></div></li><li class="listitem">
					Apply the configuration changes.
				</li></ol></div><div class="orderedlist"><p class="title"><strong>Verification</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
					Verify that your RHDH instance is running with the migrated data and does not contain the local PostgreSQL database by running the following command:
				</p><pre class="programlisting language-terminal">oc get pods -n &lt;your-namespace&gt;</pre></li><li class="listitem"><p class="simpara">
					Check the output for the following details:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							The <code class="literal">backstage-developer-hub-xxx</code> pod is in running state.
						</li><li class="listitem"><p class="simpara">
							The <code class="literal">backstage-psql-developer-hub-0</code> pod is not available.
						</p><p class="simpara">
							You can also verify these details using the <span class="strong strong"><strong>Topology</strong></span> view in the OpenShift Container Platform web console.
						</p></li></ul></div></li></ol></div></section><div><div xml:lang="en-US" class="legalnotice" id="idm46354213101360"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2024 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>